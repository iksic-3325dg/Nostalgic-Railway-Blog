<script>console.log("ğŸ§© extend_footer loaded");</script>
<style>
  /* æ¤œç´¢ãƒ‘ãƒãƒ«ã®è¦‹ãŸç›®ã€‚è¡¨ç¤ºã¯ JS ã§åˆ¶å¾¡ï¼ˆlayout ã¯ä¸€åˆ‡æŠ¼ã—åºƒã’ãªã„ï¼‰ */
  #pf-panel {
    position: fixed;
    z-index: 9999;
    width: 320px;
    max-width: calc(100vw - 24px);
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 28px rgba(0,0,0,.18);
    padding: 12px;
    display: none;             /* â† åˆæœŸã¯éè¡¨ç¤º */
  }
  #pf-panel input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    outline: none;
  }
  #pf-results { margin-top: 10px; max-height: 60vh; overflow: auto; }
  #pf-results a { text-decoration: none; color: #333; display: block; padding: 6px 0; }
  #pf-results a:hover { text-decoration: underline; }
</style>

<script type="module">
  // ----- è¨­å®šï¼šPagefind ã®JSã‚’è‡ªå‹•è§£æ±ºï¼ˆã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã‚‚å£Šã‚Œãªã„ï¼‰ -----
  const PAGEFIND_JS = new URL('pagefind/pagefind.js', document.baseURI).href;

  // ----- 1) ãƒ‘ãƒãƒ«ç”Ÿæˆï¼ˆãªã‘ã‚Œã°ä½œã‚‹ï¼‰ -----
  function ensurePanel(){
    if (document.getElementById('pf-panel')) return;
    const panel = document.createElement('div');
    panel.id = 'pf-panel';
    panel.innerHTML = `
      <input id="pf-input" type="text" placeholder="ã‚µã‚¤ãƒˆå†…æ¤œç´¢â€¦" />
      <div id="pf-results"></div>
    `;
    document.body.appendChild(panel);
  }

  // ----- 2) ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºä½ç½®ã‚’ã‚¢ã‚¤ã‚³ãƒ³ç›´ä¸‹ã«åˆã‚ã›ã‚‹ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ä¸€åˆ‡å¤‰ãˆãªã„ï¼‰ -----
  function placePanelBelowIcon(icon, panel){
    const r = icon.getBoundingClientRect();
    // ãƒ‘ãƒãƒ«å¹…ã‚’ä¸€æ—¦è¡¨ç¤ºã—ã¦æ¸¬ã‚‹
    panel.style.display = 'block';
    const panelWidth = panel.offsetWidth || 320;
    // å³ç«¯ã«å¯„ã›ã¦ã€ã‚¢ã‚¤ã‚³ãƒ³ã®çœŸä¸‹ã«å‡ºã™
    panel.style.left = Math.round(r.right - panelWidth) + 'px';
    panel.style.top  = Math.round(r.bottom + 8) + 'px';
  }

  // ----- 3) ãƒˆã‚°ãƒ«ï¼ˆé–‹é–‰ï¼‰ã¨å¤–å´ã‚¯ãƒªãƒƒã‚¯/ESC ã§é–‰ã˜ã‚‹ -----
  function bindToggle(engine){
    const iconLink = document.querySelector('.header-search a'); // æ—¢å­˜UIã‚’åˆ©ç”¨
    const panel    = document.getElementById('pf-panel');
    const input    = document.getElementById('pf-input');
    const results  = document.getElementById('pf-results');
    if (!iconLink || !panel || !input || !results) return;

    // æ—¢å­˜ãƒªã‚¹ãƒŠãƒ¼ãŒé‡è¤‡ã—ãªã„ã‚ˆã†ã«ä¸€æ—¦ã‚¯ãƒªãƒ¼ãƒ³
    iconLink.onclick = null;

    iconLink.addEventListener('click', (e)=>{
      e.preventDefault();
      if (panel.style.display === 'block') {
        panel.style.display = 'none';
        return;
      }
      placePanelBelowIcon(iconLink, panel);
      input.value = '';
      results.innerHTML = '';
      panel.style.display = 'block';
      input.focus();
    });

    // ãƒ‘ãƒãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', (e)=>{
      if (panel.style.display !== 'block') return;
      if (!e.target.closest('#pf-panel') && !e.target.closest('.header-search')) {
        panel.style.display = 'none';
      }
    });
    // Esc ã§é–‰ã˜ã‚‹
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && panel.style.display === 'block') {
        panel.style.display = 'none';
      }
    });

    // å…¥åŠ› â†’ Pagefindæ¤œç´¢ï¼ˆç°¡æ˜“ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
    let t;
    input.addEventListener('input', ()=>{
      clearTimeout(t);
      t = setTimeout(async ()=>{
        const q = input.value.trim();
        results.innerHTML = '';
        if (!q) return;

        const res = await engine.search(q);
        if (!res?.results?.length) {
          results.innerHTML = '<p>è©²å½“ã™ã‚‹çµæœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
        }
        for (const r of res.results) {
          const d = await r.data();
          const a = document.createElement('a');
          a.href = d.url;
          a.textContent = d.meta?.title || d.url;
          results.appendChild(a);
        }
      }, 160);
    });
  }

  // ----- 4) èµ·å‹•ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ -----
  ensurePanel();

  try {
    // Pagefind ã¯ default exportã€‚dynamic import â†’ åˆæœŸåŒ–
    const Pagefind = (await import(PAGEFIND_JS)).default;
    const engine   = await Pagefind();              // â† ã“ã‚ŒãŒæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³
    bindToggle(engine);
    console.log('âœ… Pagefind ready');
  } catch (err) {
    console.error('âŒ Pagefind åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
  }

  // ç”»é¢ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ãŸæ™‚ã«ãƒ‘ãƒãƒ«ä½ç½®ã‚’å†è¨ˆç®—ï¼ˆé–‹ã„ã¦ã„ã‚‹æ™‚ã ã‘ï¼‰
  window.addEventListener('resize', ()=>{
    const panel = document.getElementById('pf-panel');
    const icon  = document.querySelector('.header-search a');
    if (panel && panel.style.display === 'block' && icon) {
      placePanelBelowIcon(icon, panel);
    }
  });
</script>
