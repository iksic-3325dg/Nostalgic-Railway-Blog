{{ warnf "USING_LOCAL_FOOTER" }}
<footer class="footer">
  <span>&copy; {{ now.Year }} <a href="{{ "" | absLangURL }}">{{ site.Title }}</a></span>
</footer>

<!-- â–¼ Pagefind loaderï¼ˆå¿…ãš 1 è¡Œã§èª­ã¿è¾¼ã‚€ï¼‰ -->
<script src="{{ "pagefind/pagefind.js" | absURL }}"></script>

<style>
  /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ¤œç´¢ãƒ‘ãƒãƒ«ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‹•ã‹ã•ãªã„ï¼‰ */
  #pf-panel{
    position:fixed; z-index:9999; width:320px; max-width:calc(100vw - 24px);
    right:12px; top:72px; display:none; background:#fff; border-radius:12px;
    box-shadow:0 10px 28px rgba(0,0,0,.18); padding:12px;
  }
  #pf-panel input{ width:100%; padding:8px 10px; border:1px solid #ccc; border-radius:8px; outline:none; }
  #pf-results{ margin-top:10px; max-height:60vh; overflow:auto; }
  #pf-results a{ display:block; padding:6px 0; color:#333; text-decoration:none; }
  #pf-results a:hover{ text-decoration:underline; }
</style>

<script>
  // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ™ãƒ¼ã‚¹URLï¼ˆã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¬é–‹ã«å¯¾å¿œï¼‰
  const PF_BASE = new URL(document.baseURI).pathname;

  // ãƒ‘ãƒãƒ«ç”Ÿæˆï¼ˆé‡è¤‡ä½œæˆã—ãªã„ï¼‰
  function ensurePanel(){
    if (document.getElementById('pf-panel')) return;
    const panel = document.createElement('div');
    panel.id = 'pf-panel';
    panel.innerHTML = `
      <input id="pf-input" type="text" placeholder="ã‚µã‚¤ãƒˆå†…æ¤œç´¢â€¦">
      <div id="pf-results"></div>
    `;
    document.body.appendChild(panel);
  }

  // ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºä½ç½®ã¯å›ºå®šï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å´©ã•ãªã„ï¼‰
  function openPanel(){
    const p = document.getElementById('pf-panel');
    p.style.display = 'block';
    document.getElementById('pf-input').focus();
  }
  function closePanel(){
    const p = document.getElementById('pf-panel');
    p.style.display = 'none';
  }

  // èµ·å‹•
  window.addEventListener('load', async () => {
    console.log('ğŸ” injecting pagefindâ€¦');

    // loader ãŒæœ¬å½“ã«å…¥ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
    if (typeof window.pagefind !== 'function') {
      console.error('âŒ pagefind.js ãŒèª­ã¿è¾¼ã‚ã¦ã„ã¾ã›ã‚“ï¼ˆHTML ã« <script src="/â€¦/pagefind/pagefind.js"> ãŒç„¡ã„ï¼‰');
      return;
    }

    ensurePanel();

    // Pagefind ã‚¨ãƒ³ã‚¸ãƒ³ä½œæˆ
    const engine = await window.pagefind({ baseUrl: PF_BASE });

    // æ—¢å­˜ã®è™«çœ¼é¡ã‚¢ã‚¤ã‚³ãƒ³ã«ç´ä»˜ã‘ï¼ˆPaperMod ã® .header-search aï¼‰
    const trigger = document.querySelector('.header-search a');
    if (!trigger) { console.warn('âš ï¸ .header-search a ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

    trigger.addEventListener('click', (e) => {
      e.preventDefault();
      const p = document.getElementById('pf-panel');
      if (p.style.display === 'block') { closePanel(); return; }
      openPanel();
      document.getElementById('pf-input').value = '';
      document.getElementById('pf-results').innerHTML = '';
    });

    // å¤–å´ã‚¯ãƒªãƒƒã‚¯ / Esc ã§é–‰ã˜ã‚‹
    document.addEventListener('click', (e)=>{
      const p = document.getElementById('pf-panel');
      if (p.style.display !== 'block') return;
      if (!e.target.closest('#pf-panel') && !e.target.closest('.header-search')) closePanel();
    });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closePanel(); });

    // å…¥åŠ› â†’ æ¤œç´¢
    let t; 
    const input  = document.getElementById('pf-input');
    const list   = document.getElementById('pf-results');
    input.addEventListener('input', ()=>{
      clearTimeout(t);
      t = setTimeout(async ()=>{
        const q = input.value.trim();
        list.innerHTML = '';
        if (!q) return;

        const res = await engine.search(q);
        if (!res?.results?.length){ list.innerHTML = '<p>è©²å½“ã™ã‚‹çµæœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'; return; }
        for (const r of res.results){
          const d = await r.data();
          const a = document.createElement('a');
          a.href = d.url; a.textContent = d.meta?.title || d.url;
          list.appendChild(a);
        }
      }, 160);
    });

    console.log('âœ… Pagefind ready');
  });
</script>
